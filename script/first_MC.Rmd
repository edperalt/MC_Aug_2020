---
title: "Montecarlo simulation"
subtitle: "sensitivity to sample size "
date: "8/22/2020"
output: 
  html_document:
    toc: true
    toc_float:
      toc_collapsed: true
    toc_depth: 3
    theme: lumen
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE, include=FALSE}

library(MonteCarlo)
library(tidyverse)
library(gridExtra)


```



## Description  
This is an excercise to test set of montecarlo simulations to estimate the STOOIP of a field.  

We will perform simulation increasing the number of runs drawing data from 2 datasets, both with the same distributions, however with different number of samples:  
* All input distributions will have the 100 samples
* All input distributions will have 1E6 samples  


```{r message=FALSE, warning=FALSE, include=FALSE}
df_sample <- 1e2
```



```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}

## 
df <- 
  data.frame(area = runif( df_sample, 5, 12)) 
  
  
area_a<-                ## the plots with a will be the ones with the small distribution
  ggplot(df, aes(area))+
  geom_histogram(fill = "grey", bins = 20) +
  labs(x = "Area km2" ,
       y = "",
       title = "100 samples ")+
  theme_minimal()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank())+
  scale_x_continuous(limits = c(0,15))




```




```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}

## thickness

df$thk  <-  runif(df_sample, 8, 17)
  
  
thk_a<-
  ggplot(df, aes(thk))+
  geom_histogram(fill = "grey", bins = 20) +
  labs(x = "Thickness in meters" ,
       y = "",
       title = "100 samples")+
  theme_minimal()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank())+
   scale_x_continuous(limits = c(5,20))


```





```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}
## Porosity


df$poro  <- rnorm(df_sample, 0.2, 0.03)
  
  
poro_a<-
  ggplot(df, aes(poro))+
  geom_histogram(fill = "grey", bins = 30) +
  labs(x = "Porosity in fraction" ,
       y = "",
       title = "100 samples")+
  theme_minimal()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank())+
  scale_x_continuous(limits = c(0.05, 0.3),
                     breaks = seq(0.05, 0.3, 0.05),
                     labels = seq(0.05, 0.3, 0.05))


```




```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}

df$sw  <- rnorm(df_sample, 0.22, 0.04)
  
df<- df %>% mutate(sw = ifelse( sw < 0 , 0 ,  sw ) )
  
sw_a<-ggplot(df, aes(sw))+
  geom_histogram(fill = "grey", bins = 30) +
  labs(x = "Porosity in fraction" ,
       y = "",
       title = "100 samples")+
  theme_minimal()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank())+
  scale_x_continuous(limits = c(0.05, 0.35),
                     breaks = seq(0.1, 0.35, 0.05),
                     labels = seq(0.1, 0.35, 0.05))


```


```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}

df$bo  <- rnorm(df_sample, 1.07, 0.02)
  
  
bo_a<-ggplot(df, aes(bo))+
  geom_histogram(fill = "grey", bins = 30) +
  labs(x = "Porosity in fraction" ,
       y = "",
       title = "100 samples")+
  theme_minimal()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank())+
  scale_x_continuous(limits = c(1, 1.12),
                     # breaks = seq(0.1, 0.35, 0.05),
                     # labels = seq(0.1, 0.35, 0.05)
                     )


```




```{r message=FALSE, warning=FALSE, include=FALSE}
mc_samples_a <- 1e2
```



```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}


mc_stooip <- data.frame(id = seq(1 , mc_samples_a  ))

mc_stooip$area <- sample(df$area, size = mc_samples_a, replace = TRUE)
mc_stooip$thk  <- sample(df$thk,  size = mc_samples_a, replace = TRUE)
mc_stooip$poro <- sample(df$poro, size = mc_samples_a, replace = TRUE)
mc_stooip$sw   <- sample(df$sw,   size = mc_samples_a, replace = TRUE)
mc_stooip$bo   <- sample(df$bo,   size = mc_samples_a, replace = TRUE)

mc_stooip <- 
  mc_stooip %>%
    mutate(stooip = area *
             1e6 *        # to get to meters
             thk *
             6.28 *       # transform into bbls
             poro *
             (1-sw) /
             bo
             )


stooip_1e2_a<-
ggplot(mc_stooip, aes(stooip/1e6))+
  geom_histogram()+
  geom_vline( xintercept = quantile(mc_stooip$stooip,probs = seq(0.1, 0.9, 0.4))/1e6, color = c("blue","red", "blue" ))+
  scale_x_continuous(breaks = seq(0, 250, 10) ,
                     limits =   c(0, 250 ) ) +
  labs(x= " STOIIP MM bbls",
       title = "100 simulations from 100 samples")


```



```{r message=FALSE, warning=FALSE, include=FALSE}
mc_samples_a <- 1e3
```



```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}

mc_stooip <- data.frame(id = seq(1 , mc_samples_a  ))

mc_stooip$area <- sample(df$area, size = mc_samples_a, replace = TRUE)
mc_stooip$thk  <- sample(df$thk,  size = mc_samples_a, replace = TRUE)
mc_stooip$poro <- sample(df$poro, size = mc_samples_a, replace = TRUE)
mc_stooip$sw   <- sample(df$sw,   size = mc_samples_a, replace = TRUE)
mc_stooip$bo   <- sample(df$bo,   size = mc_samples_a, replace = TRUE)

mc_stooip <- 
  mc_stooip %>%
    mutate(stooip = area *
             1e6 *        # to get to meters
             thk *
             6.28 *       # transform into bbls
             poro *
             (1-sw) /
             bo
             )

stooip_1e3_a<-
ggplot(mc_stooip, aes(stooip/1e6))+
  geom_histogram()+
  geom_vline( xintercept = quantile(mc_stooip$stooip,probs = seq(0.1, 0.9, 0.4))/1e6, color = c("blue","red", "blue" ))+
  scale_x_continuous(breaks = seq(0, 250, 10) ,
                     limits =   c(0, 250 ) ) +
  labs(x= " STOIIP MM bbls",
       title = "1,000 simulations from 100 samples")


```




```{r message=FALSE, warning=FALSE, include=FALSE}
mc_samples_a <- 1e4
```



```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}


mc_stooip <- data.frame(id = seq(1 , mc_samples_a  ))

mc_stooip$area <- sample(df$area, size = mc_samples_a, replace = TRUE)
mc_stooip$thk  <- sample(df$thk,  size = mc_samples_a, replace = TRUE)
mc_stooip$poro <- sample(df$poro, size = mc_samples_a, replace = TRUE)
mc_stooip$sw   <- sample(df$sw,   size = mc_samples_a, replace = TRUE)
mc_stooip$bo   <- sample(df$bo,   size = mc_samples_a, replace = TRUE)

mc_stooip <- 
  mc_stooip %>%
    mutate(stooip = area *
             1e6 *        # to get to meters
             thk *
             6.28 *       # transform into bbls
             poro *
             (1-sw) /
             bo
             )

stooip_1e4_a<-
ggplot(mc_stooip, aes(stooip/1e6))+
  geom_histogram()+
  geom_vline( xintercept = quantile(mc_stooip$stooip,probs = c(0.1, 0.5, 0.9))/1e6, color = c("blue","red", "blue" ))+
  scale_x_continuous(breaks = seq(0, 250, 10) ,
                     limits =   c(0, 250 ) ) +
  labs(x= " STOIIP MM bbls",
       title = "10,000 simulations from 100 samples")


```




```{r message=FALSE, warning=FALSE, include=FALSE}
mc_samples <- 1e5
```






```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}

mc_stooip <- data.frame(id = seq(1 , mc_samples_a  ))

mc_stooip$area <- sample(df$area, size = mc_samples_a, replace = TRUE)
mc_stooip$thk  <- sample(df$thk,  size = mc_samples_a, replace = TRUE)
mc_stooip$poro <- sample(df$poro, size = mc_samples_a, replace = TRUE)
mc_stooip$sw   <- sample(df$sw,   size = mc_samples_a, replace = TRUE)
mc_stooip$bo   <- sample(df$bo,   size = mc_samples_a, replace = TRUE)

mc_stooip <- 
  mc_stooip %>%
    mutate(stooip = area *
             1e6 *        # to get to meters
             thk *
             6.28 *       # transform into bbls
             poro *
             (1-sw) /
             bo
             )

stooip_1e5_a<-
ggplot(mc_stooip, aes(stooip/1e6))+
  geom_histogram()+
  geom_vline( xintercept = quantile(mc_stooip$stooip,probs = seq(0.1, 0.9, 0.4))/1e6, color = c("blue","red", "blue" ))+
  scale_x_continuous(breaks = seq(0, 250, 10) ,
                     limits =   c(0, 250 ) ) +
  labs(x= " STOIIP MM bbls",
       title = "100,000 simulations from 100 samples")


```

```{r message=FALSE, warning=FALSE, include=FALSE}
mc_samples_a <- 1e6
```






```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}


mc_stooip <- data.frame(id = seq(1 , mc_samples_a  ))

mc_stooip$area <- sample(df$area, size = mc_samples_a, replace = TRUE)
mc_stooip$thk  <- sample(df$thk,  size = mc_samples_a, replace = TRUE)
mc_stooip$poro <- sample(df$poro, size = mc_samples_a, replace = TRUE)
mc_stooip$sw   <- sample(df$sw,   size = mc_samples_a, replace = TRUE)
mc_stooip$bo   <- sample(df$bo,   size = mc_samples_a, replace = TRUE)

mc_stooip <- 
  mc_stooip %>%
    mutate(stooip = area *
             1e6 *        # to get to meters
             thk *
             6.28 *       # transform into bbls
             poro *
             (1-sw) /
             bo
             )

stooip_1e6_a<-
ggplot(mc_stooip, aes(stooip/1e6))+
  geom_histogram()+
  geom_vline( xintercept = quantile(mc_stooip$stooip,probs = seq(0.1, 0.9, 0.4))/1e6, color = c("blue","red", "blue" ))+
  scale_x_continuous(breaks = seq(0, 250, 10) ,
                     limits =   c(0, 250 ) ) +
  labs(x= " STOIIP MM bbls",
       title = "1,000,000 simulations from 100 samples")


```



```{r number of samples 2nd analysis, message=FALSE, warning=FALSE, include=FALSE}
df_sample_b <- 1e6
```



```{r Area 2, echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}


df_b <- 
  data.frame(area = runif( df_sample_b, 5, 12)) 
  
area_b<-  
  ggplot(df_b, aes(area))+
    geom_histogram(fill = "grey", bins = 20) +
    labs(x = "Area km2" ,
         y = "",
         title = "1,000,000 samples")+
    theme_minimal()+
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
  scale_x_continuous(limits = c(0,15))




```


```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}

df_b$thk  <-  runif(df_sample_b, 8, 17)
  
 thk_b<- 
  ggplot(df_b, aes(thk))+
    geom_histogram(fill = "grey", bins = 20) +
    labs(x = "Thickness in meters" ,
         y = "",
        title = "1,000,000 samples")+
    theme_minimal()+
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
    scale_x_continuous(limits = c(5,20))


```

 


```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}

df_b$poro  <- rnorm(df_sample_b, 0.2, 0.03)

poro_b<-
  ggplot(df_b, aes(poro))+
    geom_histogram(fill = "grey", bins = 30) +
    labs(x = "Porosity in fraction" ,
         y = "",
         title = "1,000,000 samples")+
    theme_minimal()+
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
    scale_x_continuous(limits = c(0.05, 0.3),
                       breaks = seq(0.05, 0.3, 0.05),
                       labels = seq(0.05, 0.3, 0.05))


```




```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}

df_b$sw  <- rnorm(df_sample_b, 0.22, 0.04)
  
df_b<- df_b %>% mutate(sw = ifelse( sw < 0 , 0 ,  sw ) )
 
sw_b<- 
    ggplot(df_b, aes(sw))+
      geom_histogram(fill = "grey", bins = 30) +
      labs(x = "Porosity in fraction" ,
           y = "",
         title = "1,000,000 samples")+
      theme_minimal()+
      theme(panel.grid.major.x = element_blank(),
            panel.grid.minor.y = element_blank())+
      scale_x_continuous(limits = c(0.05, 0.35),
                         breaks = seq(0.1, 0.35, 0.05),
                         labels = seq(0.1, 0.35, 0.05))
    


```


```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}

df_b$bo  <- rnorm(df_sample_b, 1.07, 0.02)
  
  
 bo_b <-
  ggplot(df_b, aes(bo))+
  geom_histogram(fill = "grey", bins = 30) +
  labs(x = "Porosity in fraction" ,
       y = "",
         title = "1,000,000 samples")+
  theme_minimal()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank())+
  scale_x_continuous(limits = c(1, 1.12),
                     # breaks = seq(0.1, 0.35, 0.05),
                     # labels = seq(0.1, 0.35, 0.05)
                     )


```



```{r message=FALSE, warning=FALSE, include=FALSE}
mc_samples_b <- 1e2
```



```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}


mc_stooip_b <- data.frame(id = seq(1 , mc_samples_b  ))

mc_stooip_b$area <- sample(df_b$area, size = mc_samples_b, replace = TRUE)
mc_stooip_b$thk  <- sample(df_b$thk,  size = mc_samples_b, replace = TRUE)
mc_stooip_b$poro <- sample(df_b$poro, size = mc_samples_b, replace = TRUE)
mc_stooip_b$sw   <- sample(df_b$sw,   size = mc_samples_b, replace = TRUE)
mc_stooip_b$bo   <- sample(df_b$bo,   size = mc_samples_b, replace = TRUE)

mc_stooip_b <- 
  mc_stooip_b %>%
    mutate(stooip = area *
             1e6 *        # to get to meters
             thk *
             6.28 *       # transform into bbls
             poro *
             (1-sw) /
             bo
             )

 stooip_1e2_b<-
    ggplot(mc_stooip_b, aes(stooip/1e6))+
      geom_histogram()+
      geom_vline( xintercept = quantile(mc_stooip_b$stooip,probs = seq(0.1, 0.9, 0.4))/1e6, color = c("blue","red", "blue" ))+
  scale_x_continuous(breaks = seq(0, 250, 10) ,
                     limits =   c(0, 250 ) ) +
      labs(x= " STOIIP MM bbls",
           title = "100 simulations from 1,000,000 samples")


```



```{r message=FALSE, warning=FALSE, include=FALSE}
mc_samples_b <- 1e3
```



```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}




mc_stooip_b <- data.frame(id = seq(1 , mc_samples_b  ))

mc_stooip_b$area <- sample(df_b$area, size = mc_samples_b, replace = TRUE)
mc_stooip_b$thk  <- sample(df_b$thk,  size = mc_samples_b, replace = TRUE)
mc_stooip_b$poro <- sample(df_b$poro, size = mc_samples_b, replace = TRUE)
mc_stooip_b$sw   <- sample(df_b$sw,   size = mc_samples_b, replace = TRUE)
mc_stooip_b$bo   <- sample(df_b$bo,   size = mc_samples_b, replace = TRUE)

mc_stooip_b <- 
  mc_stooip_b %>%
    mutate(stooip = area *
             1e6 *        # to get to meters
             thk *
             6.28 *       # transform into bbls
             poro *
             (1-sw) /
             bo
             )

 stooip_1e3_b<-
    ggplot(mc_stooip_b, aes(stooip/1e6))+
      geom_histogram()+
      geom_vline( xintercept = quantile(mc_stooip_b$stooip,probs = seq(0.1, 0.9, 0.4))/1e6, color = c("blue","red", "blue" ))+
      scale_x_continuous(breaks = seq(0,250, 10))+  scale_x_continuous(breaks = seq(0, 250, 10) ,
                     limits =   c(0, 250 ) ) +      labs(x= " STOIIP MM bbls",
           title = "1,000 simulations from 1,000,000 samples")


```




```{r message=FALSE, warning=FALSE, include=FALSE}
mc_samples_b <- 1e4
```




```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}



mc_stooip_b <- data.frame(id = seq(1 , mc_samples_b  ))

mc_stooip_b$area <- sample(df_b$area, size = mc_samples_b, replace = TRUE)
mc_stooip_b$thk  <- sample(df_b$thk,  size = mc_samples_b, replace = TRUE)
mc_stooip_b$poro <- sample(df_b$poro, size = mc_samples_b, replace = TRUE)
mc_stooip_b$sw   <- sample(df_b$sw,   size = mc_samples_b, replace = TRUE)
mc_stooip_b$bo   <- sample(df_b$bo,   size = mc_samples_b, replace = TRUE)

mc_stooip_b <- 
  mc_stooip_b %>%
    mutate(stooip = area *
             1e6 *        # to get to meters
             thk *
             6.28 *       # transform into bbls
             poro *
             (1-sw) /
             bo
             )

stooip_1e4_b<-
    ggplot(mc_stooip_b, aes(stooip/1e6))+
      geom_histogram()+
      geom_vline( xintercept = quantile(mc_stooip_b$stooip,probs = seq(0.1, 0.9, 0.4))/1e6, color = c("blue","red", "blue" ))+
     scale_x_continuous(breaks = seq(0, 250, 10) ,
                        limits =   c(0, 250 ) ) +
      labs(x= " STOIIP MM bbls",
           title = "10,000 simulations from 1,000,000 samples")


```




```{r message=FALSE, warning=FALSE, include=FALSE}
mc_samples_b <- 1e5
```






```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}



mc_stooip_b <- data.frame(id = seq(1 , mc_samples_b  ))

mc_stooip_b$area <- sample(df_b$area, size = mc_samples_b, replace = TRUE)
mc_stooip_b$thk  <- sample(df_b$thk,  size = mc_samples_b, replace = TRUE)
mc_stooip_b$poro <- sample(df_b$poro, size = mc_samples_b, replace = TRUE)
mc_stooip_b$sw   <- sample(df_b$sw,   size = mc_samples_b, replace = TRUE)
mc_stooip_b$bo   <- sample(df_b$bo,   size = mc_samples_b, replace = TRUE)

mc_stooip_b <- 
  mc_stooip_b %>%
    mutate(stooip = area *
             1e6 *        # to get to meters
             thk *
             6.28 *       # transform into bbls
             poro *
             (1-sw) /
             bo
             )

stooip_1e5_b<-
    ggplot(mc_stooip_b, aes(stooip/1e6))+
      geom_histogram()+
      geom_vline( xintercept = quantile(mc_stooip_b$stooip,probs = seq(0.1, 0.9, 0.4))/1e6, color = c("blue","red", "blue" ))+
        scale_x_continuous(breaks = seq(0, 250, 10) ,
                     limits =   c(0, 250 ) ) +
      labs(x= " STOIIP MM bbls",
           title = "100,000 simulations from 1,000,000 samples")


```




```{r message=FALSE, warning=FALSE, include=FALSE}
mc_samples_b <- 1e6
```





```{r echo=FALSE, fig.height=2.5, fig.width=6, message=FALSE, warning=FALSE}




mc_stooip_b <- data.frame(id = seq(1 , mc_samples_b  ))

mc_stooip_b$area <- sample(df_b$area, size = mc_samples_b, replace = TRUE)
mc_stooip_b$thk  <- sample(df_b$thk,  size = mc_samples_b, replace = TRUE)
mc_stooip_b$poro <- sample(df_b$poro, size = mc_samples_b, replace = TRUE)
mc_stooip_b$sw   <- sample(df_b$sw,   size = mc_samples_b, replace = TRUE)
mc_stooip_b$bo   <- sample(df_b$bo,   size = mc_samples_b, replace = TRUE)

mc_stooip_b <- 
  mc_stooip_b %>%
    mutate(stooip = area *
             1e6 *        # to get to meters
             thk *
             6.28 *       # transform into bbls
             poro *
             (1-sw) /
             bo
             )

stooip_1e6_b<-
    ggplot(mc_stooip_b, aes(stooip/1e6))+
      geom_histogram()+
      geom_vline( xintercept = quantile(mc_stooip_b$stooip,probs = seq(0.1, 0.9, 0.4))/1e6, color = c("blue","red", "blue" ))+
        scale_x_continuous(breaks = seq(0, 250, 10) ,
                     limits =   c(0, 250 ) ) +
      labs(x= " STOIIP MM bbls",
           title = "1,000,000 simulations from 1,000,000 samples")


```


## Distributions used

### Area

The area has been  set as an uniform distribution between 5 and 12 km^2^.    


```{r echo=FALSE, message=FALSE, warning=FALSE}

grid.arrange(area_a, area_b)
```

### Thickness


Thickness is defined as a uniform distribution between 8 and 17 meters

```{r  warning=FALSE, message=FALSE, echo=FALSE}

grid.arrange(thk_a, thk_b)


```

### Porosity

Porosity distribution is normal with a mean of 20% and 3% standard deviation.  

```{r warning=FALSE, message=FALSE, echo=FALSE}
grid.arrange(poro_a, poro_b)
```


### Water saturation

Water saturation distribution is normal with a mean of 22% and 4% standard deviation.  

```{r  warning=FALSE, message=FALSE, echo=FALSE}

grid.arrange(sw_a, sw_b)
```


### Bo

Bo distribution is normal with a mean of 1.07 and 0.02 standard deviation.  


```{r warning=FALSE, message=FALSE,echo=FALSE}
grid.arrange(bo_a, bo_b)
```

## Montecarlo simulations 

The STOOIP is estimated in bbls with the following formula:

$$ STOOIP = Area * Thickness * Porosity * ( 1 - Sw ) / Bo $$  

Blue lines represent p10 and p90 and the red line the p50.

###  100 simulations

```{r warning=FALSE, message=FALSE, echo=FALSE}

grid.arrange(stooip_1e2_a, stooip_1e2_b)


```


### 1,000 simulations

```{r warning=FALSE, message=FALSE, echo=FALSE}

grid.arrange(stooip_1e3_a, stooip_1e3_b)


```


### 10,000 simulations

```{r warning=FALSE, message=FALSE, echo=FALSE}

grid.arrange(stooip_1e4_a, stooip_1e4_b)


```




###  100,000 simulations

```{r warning=FALSE, message=FALSE, echo=FALSE}

grid.arrange(stooip_1e5_a, stooip_1e5_b)


```





###  1,000,000 simulations

```{r warning=FALSE, message=FALSE, echo=FALSE}

grid.arrange(stooip_1e6_a, stooip_1e6_b)


```





